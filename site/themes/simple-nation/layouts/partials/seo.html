{{/*
  SEO and social sharing meta tags
  - Works for homepage, sections, and single pages
  - Uses .Params.image (or cover/featured_image) when available, else default theme image
*/}}

{{- $isSection := and (ne .IsHome true) (eq .Kind "section") -}}
{{- $isArticle := and (not $isSection) (or (eq .Section "essays") (eq .Section "fragments") (eq .Section "ai")) -}}
{{- $title := .Title -}}
{{- $url := .Permalink -}}

{{/* Build description with multiple fallbacks */}}
{{- $desc := "" -}}

{{/* 1. First try explicit description from frontmatter */}}
{{- with .Params.description -}}
  {{- $desc = . -}}
{{- end -}}

{{/* 2. If no explicit description, try Hugo's Summary */}}
{{- if eq $desc "" -}}
  {{- $summary := .Summary | plainify | replaceRE `\s+` " " | strings.TrimSpace -}}
  {{- if gt (len $summary) 10 -}}
    {{- $desc = $summary | truncate 200 -}}
  {{- end -}}
{{- end -}}

{{/* 3. If still empty, extract from plain content */}}
{{- if eq $desc "" -}}
  {{- $plainContent := .Content | plainify | replaceRE `\s+` " " | strings.TrimSpace -}}
  {{- if gt (len $plainContent) 10 -}}
    {{- $desc = $plainContent | truncate 200 -}}
  {{- end -}}
{{- end -}}

{{/* 4. Final fallback to site title */}}
{{- if eq $desc "" -}}
  {{- $desc = .Site.Title -}}
{{- end -}}

{{/* Override for homepage and section pages */}}
{{- if .IsHome -}}
  {{- $desc = "Stories, ideas, and notes from my life, work, and beyond." -}}
{{- else if $isSection -}}
  {{- if eq .Section "fragments" -}}
    {{- $desc = "Short thoughts, observations, and fragmented ideas on technology, life, and everything in between." -}}
  {{- else if eq .Section "essays" -}}
    {{- $desc = "Long-form essays exploring ideas, experiences, and deeper thoughts." -}}
  {{- else if eq .Section "ai" -}}
    {{- $desc = "Essays and articles about AI, machine learning, and artificial intelligence." -}}
  {{- else -}}
    {{- $desc = printf "Collection of %s from %s" (.Section | title) .Site.Title -}}
  {{- end -}}
{{- end -}}

{{/* Resolve social image in a way compatible with older Hugo */}}
{{- $img := ("images/prashish_rajbhandari.jpg" | absURL) -}}
{{- with .Params.image -}}
  {{- $img = (. | absURL) -}}
{{- else -}}
  {{- with .Params.cover -}}
    {{- $img = (. | absURL) -}}
  {{- else -}}
    {{- with .Params.featured_image -}}
      {{- $img = (. | absURL) -}}
    {{- else -}}
      {{/* Fallback: first <img src="..."> in content */}}
      {{- $first := findRE `(?i)<img[^>]+src=["']([^"']+)["']` .Content 1 -}}
      {{- if gt (len $first) 0 -}}
        {{- $firstSrc := replaceRE `(?i).*src=["']([^"']+)["'].*` "$1" (index $first 0) -}}
        {{- if $firstSrc -}}{{- $img = ($firstSrc | absURL) -}}{{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

<link rel="canonical" href="{{ $url }}"/>
<meta name="description" content="{{ $desc }}"/>
<meta name="robots" content="index,follow"/>

{{/* Open Graph */}}
<meta property="og:site_name" content="{{ .Site.Title }}"/>
<meta property="og:title" content="{{ $title }}"/>
<meta property="og:description" content="{{ $desc }}"/>
<meta property="og:type" content="{{ if $isArticle }}article{{ else if $isSection }}website{{ else }}website{{ end }}"/>
<meta property="og:url" content="{{ $url }}"/>
<meta property="og:image" content="{{ $img }}"/>
{{ if $isArticle }}
  <meta property="article:published_time" content="{{ .PublishDate.UTC.Format "2006-01-02T15:04:05Z07:00" }}"/>
  <meta property="article:modified_time" content="{{ .Lastmod.UTC.Format "2006-01-02T15:04:05Z07:00" }}"/>
{{ end }}

{{/* Twitter */}}
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:title" content="{{ $title }}"/>
<meta name="twitter:description" content="{{ $desc }}"/>
<meta name="twitter:image" content="{{ $img }}"/>

{{/* RSS autodiscovery - section-aware */}}
{{- $rssURL := "index.xml" | relURL -}}
{{- if $isSection -}}
  {{- $rssURL = printf "%s/index.xml" (.Section | relURL) -}}
{{- end -}}
<link rel="alternate" type="application/rss+xml" title="{{ .Site.Title }}" href="{{ $rssURL }}"/>

{{ if $isArticle }}
  {{/* JSON-LD Article schema */}}
  {{- $author := default "Prashish" .Params.author -}}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": {{ $title | jsonify }},
    "description": {{ $desc | jsonify }},
    "image": {{ $img | jsonify }},
    "author": { "@type": "Person", "name": {{ $author | jsonify }} },
    "datePublished": "{{ .PublishDate.UTC.Format "2006-01-02T15:04:05Z07:00" }}",
    "dateModified": "{{ .Lastmod.UTC.Format "2006-01-02T15:04:05Z07:00" }}",
    "mainEntityOfPage": { "@type": "WebPage", "@id": {{ $url | jsonify }} }
  }
  </script>
{{ else if $isSection }}
  {{/* JSON-LD CollectionPage schema for section listing pages */}}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "CollectionPage",
    "name": {{ $title | jsonify }},
    "description": {{ $desc | jsonify }},
    "url": {{ $url | jsonify }},
    "mainEntity": {
      "@type": "ItemList",
      "numberOfItems": {{ len .Data.Pages }},
      "itemListElement": [
        {{- range $index, $page := first 10 .Data.Pages.ByDate.Reverse -}}
        {{- if $index }},{{- end }}
        {
          "@type": "ListItem",
          "position": {{ add $index 1 }},
          "item": {
            "@type": "Article",
            "name": {{ $page.Title | jsonify }},
            "url": {{ $page.Permalink | jsonify }}
          }
        }
        {{- end -}}
      ]
    }
  }
  </script>
{{ end }}


